name: Validate Lockfile and Node Version

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read

jobs:
  validate-lockfile:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup pnpm
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0
        # uses version from "packageManager" field in package.json

      - name: Setup Node.js
        uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4.2.0
        with:
          node-version-file: '.node-version'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate mermaid-live-editor compatibility
        run: |
          echo "Checking Node version compatibility for mermaid-live-editor..."
          if [ ! -d "mermaid-live-editor" ]; then
            git clone --single-branch https://github.com/mermaid-js/mermaid-live-editor.git
          fi
          cd mermaid-live-editor

          # Check package.json engines requirement
          REQUIRED_NODE=$(node -p "require('./package.json').engines?.node || 'not specified'")
          CURRENT_NODE=$(node --version)

          echo "Required Node version: $REQUIRED_NODE"
          echo "Current Node version: $CURRENT_NODE"

          # Test yarn install with current Node version
          yarn install

      - name: Validate build process
        run: |
          echo "Testing editor.bash script compatibility..."
          # Set required environment variables
          export COMMIT_REF="${{ github.sha }}"
          export NODE_OPTIONS="--max_old_space_size=4096"
          export COREPACK_ENABLE_STRICT='0'

          # Run the editor script to validate it works with Node 20
          ./scripts/editor.bash
