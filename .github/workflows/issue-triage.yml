name: Apply triage label to new issue

on:
  issues:
    types: [opened]

permissions: # added using https://github.com/step-security/secure-repo
  contents: read

jobs:
  triage:
    permissions:
      issues: write # for andymckay/labeler to label issues
      pull-requests: write # for andymckay/labeler to label PRs
    runs-on: ubuntu-latest
    steps:
      - uses: andymckay/labeler@e6c4322d0397f3240f0e7e30a33b5c5df2d39e90 # 1.0.4
        with:
          repo-token: '${{ secrets.GITHUB_TOKEN }}'
          add-labels: 'Status: Triage'
      - name: Check for duplicate issues
        uses: actions/github-script@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: issues } = await github.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'Status: Triage'
            });
            const duplicate = issues.find(issue => issue.title === context.payload.issue.title);
            if (duplicate) {
              await github.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                labels: ['duplicate']
              });
            }
